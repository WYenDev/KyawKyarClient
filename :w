import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { useAuth } from '../../contexts/AuthContext';
import { usePostApiAuthLogin } from '../../services/api';


interface LoginForm {
  username: string;
  password: string;
}


const AdminLogin: React.FC = () => {
  const { t } = useTranslation('admin');
  const navigate = useNavigate();
  const { login } = useAuth();

  const [form, setForm] = useState<LoginForm>({ username: '', password: '' });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const loginMutation = usePostApiAuthLogin({
    mutation: {
      onSuccess: (response, variables) => {
        // 'response' is the PostApiAuthLogin200 object from Orval
        // 'variables' contains the { data: { username, password } } sent to the API

        console.log("Login successful:", response);
        if (response.accessToken && variables.data.username) {
          //if (response.accessToken) {
          // 1. Update Context (which also updates Axios headers via the Provider's useEffect)
          login(variables.data.username, response.accessToken);
          //login("test", response.accessToken);

          // 2. Navigate to the protected area
          navigate('/admin/');
        }
      },
      onError: (error) => {
        console.error("Login failed:", error);
      }
    }
  });


  const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setForm((s) => ({ ...s, [e.target.name]: e.target.value }));
  };

  const handleSubmit = async (e?: React.FormEvent) => {
    e?.preventDefault();
    setError(null);
    setLoading(true);

    try {
      setLoading(false);
      loginMutation.mutate({
        data: {
          username: form.username,
          password: form.password
        }
      });
    }
    catch (err) {
      setLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <form
        onSubmit={handleSubmit}
        className="w-full max-w-md bg-white shadow rounded-lg p-6"
        aria-labelledby="admin-login-title"
      >
        <h1 id="admin-login-title" className="text-2xl font-semibold mb-4">
          {t('login.title')}
        </h1>

        {error && (
          <div className="mb-4 text-sm text-red-700 bg-red-100 p-2 rounded">{error}</div>
        )}

        <label className="block mb-3">
          <span className="text-sm font-medium text-gray-700">{t('login.email') || 'Email'}</span>
          <input
            name="username"
            value={form.username}
            onChange={onChange}
            required
            className="mt-1 block w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder={t('login.emailPlaceholder')}
            autoComplete="username"
          />
        </label>

        <label className="block mb-4">
          <span className="text-sm font-medium text-gray-700">
            {t('login.password')}
          </span>
          <input
            name="password"
            type="password"
            value={form.password}
            onChange={onChange}
            required
            className="mt-1 block w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder={t('login.passwordPlaceholder')}
            autoComplete="current-password"
          />
        </label>

        <button
          type="submit"
          disabled={loading}
          className="w-full inline-flex items-center justify-center px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:opacity-60"
        >
          {loading ? t('login.loading') : t('login.submit')}
        </button>
      </form>
    </div>
  );
};

export default AdminLogin;
